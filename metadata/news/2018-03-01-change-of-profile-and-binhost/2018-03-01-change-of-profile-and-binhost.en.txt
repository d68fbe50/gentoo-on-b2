Title: Change of profile and binhost
Author: sakaki <sakaki@deciban.com>
Content-Type: text/plain
Posted: 2018-03-01
Revision: 1
News-Item-Format: 2.0
Display-If-Keyword: ppc

Introduction
------------

Please note that the binhost for the gentoo-on-b2 project has now
shifted to using the new 17.0 profile (from 13.0).

Profiles are changed rarely in Gentoo, for they determine how your
entire system is built, often in backwards-incompatible ways. For example,
in 17.0, the gcc compiler defaults to creating position independent
executables (aka, 'pie'), which it did not do before.

Accordingly (and as officially recommended [1]), all project packages have
been rebuilt under the new 17.0 profile, and, to avoid confusion, a
new binhost has been created to house these, at https://isshoni.org/b2pie.
This is now the binhost that will receive weekly autoupdates, going forward.

The old 13.0 binhost, at https://isshoni.org/b2, will be retained for
historical interest (at least for a while), but will no longer be
autoupdated.

Impact
------

As such, *action is required* if you want to keep your system up-to-date
and retain the convenience of the binhost in future. Just running 'genup'
is *not* sufficient - please instead follow the instructions below.

Upgrade Instructions
--------------------

First, make sure you have at least 2GiB of free space on your B2's
filesystem (use "df -h" to check), and that you are using at least
version 6.4.0 of gcc (use "gcc-config --list-profiles" to check; look for
the version marked with the asterisk).

Then, if that all looks good, proceed to update your ebuild repositories.
As root, issue:

b2 ~# emaint sync --auto

Next, switch to an appropriate 17.0 profile; for example:

b2 ~# eselect profile set "default/linux/powerpc/ppc32/17.0"

You also need to switch your binary package host ('binhost'), to use the
new 17.0 variant mentioned in the introduction. To do so, issue:

b2 ~# nano -w /etc/portage/make.conf

and modify the line that currently reads:

PORTAGE_BINHOST="https://isshoni.org/b2"

so it now reads instead:

PORTAGE_BINHOST="https://isshoni.org/b2pie"

Leave the rest of the file as-is. Save, and exit nano.

Now you can update the core build system. Do *not* follow the advice in
the official news article [1] to rebuild gcc, binutils and glibc individually
(if you do, you'll end up building them locally, rather than pulling the
new binaries from the binhost, which will take a *long* time).

Instead, issue:

b2 ~# emerge --ask --verbose sys-devel/gcc sys-devel/binutils sys-libs/glibc

Check (when the above command prompts you for confirmation) that you
will indeed be installing binary packages - this is a good indication
you have set things up correctly.

Once this completes, rebuild your entire system for profile 17.0. Almost
all of the required 900 or so packages should be available on the new
binhost you just switched to, so this should only take a few hours
(unless you have added many additional packages to the image yourself).

Issue:

b2 ~# nice emerge --ask --verbose --emptytree --with-bdeps=y @world

Once it has completed, issue:

b2 ~# nice emerge @preserved-rebuild

then:

b2 ~# dispatch-conf

to resolve any proposed configuration file changes (for the most part,
if you had a reasonably up-to-date 13.0 profile system to start with,
typing z to 'zap' (discard) most of these proposed changes should be safe;
a lot of packages have been re-installed here, but you want to keep your
*prior* configuration, not roll it back to 'shipped defaults').

Once done, reboot your system. Then log in again as root, and issue:

b2 ~# genup

Once this has completed, congratulations, you have migrated to profile
17.0! From this point, the automated weekly genup run should keep your
system correctly up-to-date.

Best, sakaki <sakaki@deciban.com>

[1] https://www.gentoo.org/support/news-items/2017-11-30-new-17-profiles.html
